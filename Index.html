<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BTC Explainer — Live Update & Archive</title>
<style>
  :root{
    --bg:#0f1115; --panel:#121722; --card:#171a21; --ink:#e9eef7; --muted:#a9b4c2; --accent:#7aa2ff; --good:#a2ffd3; --bad:#ff8a8a;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;
       background: radial-gradient(1200px 800px at 20% -10%, #1d2233 0%, #0f1115 60%);
       color:var(--ink); -webkit-font-smoothing:antialiased; line-height:1.6}
  .layout{max-width:1100px; margin:0 auto; padding:18px}
  header{display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between}
  h1{margin:.2rem 0 .4rem 0; font-size:1.6rem}
  .controls{display:flex; gap:10px; flex-wrap:wrap}
  button{appearance:none; border:1px solid rgba(255,255,255,.18); background:#22283a; color:var(--ink);
         border-radius:10px; padding:10px 12px; font-size:.95rem}
  .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; margin-top:10px}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.06));
        border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .price{font-size:2rem; font-weight:700}
  .sub{color:var(--muted)}
  .good{color:var(--good)} .bad{color:var(--bad)}
  canvas{width:100%; height:240px; background:#0c1018; border-radius:12px; border:1px solid rgba(255,255,255,.06)}
  .explain ul{padding-left:1.2rem; margin:.4rem 0}
  .small{font-size:.9rem; color:var(--muted)}
  .archive-item{border-top:1px dashed rgba(255,255,255,.15); padding-top:8px; margin-top:8px}
  .row{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
  .pill{display:inline-block; padding:4px 8px; border:1px solid rgba(255,255,255,.2); border-radius:999px; margin-right:6px; font-size:.85rem}
</style>
</head>
<body>
<div class="layout">
  <header>
    <div>
      <h1>BTC Explainer — Live Update & Archive</h1>
      <div class="sub">Fetches recent Bitcoin data (CoinGecko), draws the last 60 minutes, and explains the move. Each update is saved to your device.</div>
    </div>
    <div class="controls">
      <button id="update">Update now</button>
      <button id="clear-archive">Clear archive</button>
    </div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="row">
        <div class="price" id="price">—</div>
        <div>
          <div><span class="pill" id="p1m">1m: —</span><span class="pill" id="p15m">15m: —</span><span class="pill" id="p60m">60m: —</span></div>
          <div class="small" id="time">Last update: —</div>
        </div>
      </div>
      <canvas id="chart" width="800" height="240" aria-label="BTC last 60 minutes chart"></canvas>
      <div class="small">Data source: CoinGecko public API. Times are local to your device.</div>
    </section>

    <section class="card explain">
      <h3 style="margin:.2rem 0 .4rem 0">Explanation</h3>
      <div id="summary">Press “Update now” to fetch data.</div>
    </section>
  </div>

  <section class="card" style="margin-top:14px">
    <h3 style="margin:.2rem 0 .4rem 0">Archive (on this device)</h3>
    <div class="small">Each time you press “Update now,” a snapshot is saved with the analysis. Scroll to review your past reads.</div>
    <div id="archive"></div>
  </section>

  <p class="small">Educational use only — not financial advice.</p>
</div>

<script>
const API = "https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=1&interval=minutely";

const fmtUSD = x => x==null ? "—" : "$" + x.toLocaleString(undefined, {maximumFractionDigits: 2});
const ago = ms => {
  const s = Math.floor(ms/1000);
  if(s<60) return s+"s ago";
  const m = Math.floor(s/60);
  if(m<60) return m+"m ago";
  return Math.floor(m/60)+"h ago";
};

function drawChart(ctx, prices){
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
  const w = ctx.canvas.width, h = ctx.canvas.height;
  // compute min/max
  const ys = prices.map(p=>p[1]);
  const min = Math.min(...ys), max = Math.max(...ys);
  const pad = (max-min)*0.1 || 1;
  const lo = min - pad, hi = max + pad;
  // grid
  ctx.strokeStyle = "rgba(255,255,255,.08)";
  ctx.lineWidth = 1;
  for(let i=0;i<5;i++){
    const y = i*(h-20)/4 + 10;
    ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(w-10,y); ctx.stroke();
  }
  // axis labels
  ctx.fillStyle = "rgba(233,238,247,.7)";
  ctx.font = "12px -apple-system, system-ui, sans-serif";
  ctx.fillText(fmtUSD(hi), 6, 12);
  ctx.fillText(fmtUSD(lo), 6, h-6);

  // line path
  const left = 40, right = w-10, top = 10, bottom = h-10;
  const n = prices.length;
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<n;i++){
    const x = left + (i/(n-1))*(right-left);
    const yVal = prices[i][1];
    const y = bottom - ( (yVal - lo) / (hi - lo) ) * (bottom - top);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle = "#7aa2ff"; ctx.stroke();
  // last price dot
  const lastX = right, lastYVal = prices[n-1][1];
  const lastY = bottom - ( (lastYVal - lo) / (hi - lo) ) * (bottom - top);
  ctx.fillStyle = "#a2ffd3"; ctx.beginPath(); ctx.arc(lastX, lastY, 4, 0, Math.PI*2); ctx.fill();
}

function linearRegression(y){
  const n = y.length;
  const xs = Array.from({length:n}, (_,i)=>i);
  const sum = arr => arr.reduce((a,b)=>a+b,0);
  const sumx = sum(xs), sumy = sum(y);
  const sumxy = sum(xs.map((x,i)=>x*y[i]));
  const sumx2 = sum(xs.map(x=>x*x));
  const slope = (n*sumxy - sumx*sumy) / (n*sumx2 - sumx*sumx);
  const intercept = (sumy - slope*sumx)/n;
  // R^2
  const ymean = sumy/n;
  const ssTot = sum(y.map(v => (v-ymean)*(v-ymean)));
  const ssRes = sum(y.map((v,i)=> { const f = slope*xs[i]+intercept; return (v-f)*(v-f);}));
  const r2 = 1 - (ssRes/ssTot);
  return {slope, r2};
}

function analyze(prices, volumes){
  const last = prices[prices.length-1][1];
  const idx = prices.length-1;
  const pick = (mins) => {
    const i = Math.max(0, idx - mins);
    return prices[i][1];
  };
  const p1 = pick(1), p15 = pick(15), p60 = pick(60);
  const ch = (a,b)=> ((a-b)/b)*100;
  const c1 = p1? ch(last,p1):null;
  const c15 = p15? ch(last,p15):null;
  const c60 = p60? ch(last,p60):null;

  // Regression on last 30 points for trend & R^2
  const lastN = prices.slice(-30).map(p=>p[1]);
  const {slope, r2} = linearRegression(lastN);

  // Volatility (std dev) on last 30
  const mean = lastN.reduce((a,b)=>a+b,0)/lastN.length;
  const sd = Math.sqrt(lastN.reduce((a,b)=>a+(b-mean)*(b-mean),0)/lastN.length);
  const volNow = volumes.slice(-30).map(v=>v[1]);
  const volMean = volNow.reduce((a,b)=>a+b,0)/volNow.length;
  const volLast = volumes[volumes.length-1][1];

  // Support/Resistance: recent min/max of last 60
  const window = prices.slice(-60).map(p=>p[1]);
  const recentMin = Math.min(...window);
  const recentMax = Math.max(...window);

  const dir = slope>0 ? "up" : "down";
  const momentum = Math.abs(slope)/(mean||1);
  let momLabel = momentum>0.002 ? "strong" : momentum>0.001 ? "moderate" : "weak";

  const expl = [];
  expl.push(`Trend (last 30 min): <b>${dir}</b> with <b>${momLabel}</b> momentum (R² ${r2.toFixed(2)}).`);
  if(c1!=null) expl.push(`Change: 1m <b>${c1.toFixed(2)}%</b>, 15m <b>${c15.toFixed(2)}%</b>, 60m <b>${c60.toFixed(2)}%</b>.`);
  expl.push(`Volatility (30m stdev): <b>${sd.toFixed(2)}</b> USD.`);
  const volNote = volLast>volMean*1.3 ? "above" : volLast<volMean*0.7 ? "below" : "near";
  expl.push(`Volume now is <b>${volNote}</b> its 30m average.`);
  const pos = last < recentMin+ (recentMax-recentMin)*0.15 ? "near recent support" :
              last > recentMax - (recentMax-recentMin)*0.15 ? "near recent resistance" : "mid-range";
  expl.push(`Price is <b>${pos}</b> (60m range: ${fmtUSD(recentMin)} – ${fmtUSD(recentMax)}).`);
  return {last, c1, c15, c60, summary: "<ul><li>" + expl.join("</li><li>") + "</li></ul>"};
}

function toLocalISO(ms){
  const d = new Date(ms);
  return d.toLocaleString();
}

function saveArchive(obj){
  const key = "btc_explainer_archive_v1";
  const arr = JSON.parse(localStorage.getItem(key) || "[]");
  arr.unshift(obj);
  localStorage.setItem(key, JSON.stringify(arr.slice(0,100))); // cap to 100 entries
  renderArchive();
}

function renderArchive(){
  const key = "btc_explainer_archive_v1";
  const arr = JSON.parse(localStorage.getItem(key) || "[]");
  const box = document.getElementById('archive');
  if(arr.length===0){ box.innerHTML = '<div class="small">No snapshots yet.</div>'; return; }
  box.innerHTML = arr.map(a=>{
    const cls = a.c1>=0 ? 'good' : 'bad';
    return `<div class="archive-item">
      <div><b>${a.time}</b> — <span class="${cls}">${fmtUSD(a.last)}</span> (1m ${a.c1.toFixed(2)}%, 15m ${a.c15.toFixed(2)}%)</div>
      <div class="small">${a.summary.replace(/<[^>]+>/g,' ').slice(0,220)}…</div>
    </div>`;
  }).join("");
}

async function updateNow(){
  const priceEl = document.getElementById('price');
  const timeEl = document.getElementById('time');
  const p1 = document.getElementById('p1m'), p15 = document.getElementById('p15m'), p60 = document.getElementById('p60m');
  const chart = document.getElementById('chart'); const ctx = chart.getContext('2d');
  const summary = document.getElementById('summary');

  priceEl.textContent = "Loading…";
  try{
    const res = await fetch(API, {cache:'no-store'});
    if(!res.ok) throw new Error("API error " + res.status);
    const data = await res.json();
    // prices: [ [timestamp, price], ... ], total_volumes: [ [timestamp, volume], ... ]
    const prices = data.prices.slice(-120); // last 120 minutes
    const volumes = data.total_volumes.slice(-120);
    drawChart(ctx, prices.slice(-60)); // draw last 60 minutes
    const a = analyze(prices, volumes);
    priceEl.innerHTML = fmtUSD(a.last);
    p1.textContent = "1m: " + (a.c1>=0?"+":"") + a.c1.toFixed(2) + "%";
    p15.textContent = "15m: " + (a.c15>=0?"+":"") + a.c15.toFixed(2) + "%";
    p60.textContent = "60m: " + (a.c60>=0?"+":"") + a.c60.toFixed(2) + "%";
    p1.style.color = a.c1>=0 ? "var(--good)" : "var(--bad)";
    p15.style.color = a.c15>=0 ? "var(--good)" : "var(--bad)";
    p60.style.color = a.c60>=0 ? "var(--good)" : "var(--bad)";
    const now = Date.now();
    timeEl.textContent = "Last update: " + new Date(now).toLocaleTimeString();
    summary.innerHTML = a.summary;
    saveArchive({time:new Date(now).toLocaleString(), last:a.last, c1:a.c1, c15:a.c15, summary:a.summary});
  }catch(err){
    priceEl.textContent = "—";
    summary.innerHTML = `<span class="bad">Error fetching data:</span> ${err.message}`;
  }
}

document.getElementById('update').addEventListener('click', updateNow);
document.getElementById('clear-archive').addEventListener('click', ()=>{
  localStorage.removeItem("btc_explainer_archive_v1");
  renderArchive();
});

renderArchive();
</script>
</body>
</html>
